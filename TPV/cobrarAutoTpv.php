<?phprequire_once('../Connections/conexionComanderEnvCam.php');require_once('../includes/funcionesEnvCam.php');if (!isset($_SESSION)) {    session_start();}$MM_authorizedUsers = "3,2,1";$MM_donotCheckaccess = "false";include '../includes/restriccionCam.php';$idMesa = $_GET['idMesa'];$idVisitante = $_GET['idUsuarioNotificaciones'];$idNotificacion = $_GET['idNotificacion'];$control = 0;$controlComandas = 0;$ArrayComandas = Array();$ArrayMenus = Array();$tabla = 'comandatemp_' . $idVisitante;mysqli_select_db($comcon, $database_comcon);$comprueba = mysqli_query($comcon, "SHOW TABLES LIKE '".$tabla."'");$cant_comprueba= mysqli_num_rows ($comprueba);if($cant_comprueba == null) {    header('Location:principalEnvCam.php');}$query_RegComanda = "SELECT * FROM " . $tabla . " WHERE cantidadComandaTemp > 0 AND idGrupoMenuComandaTemp IS NULL";$RegComanda = mysqli_query($comcon, $query_RegComanda) or die(mysqli_connect_error());$totalRows_RegComanda = mysqli_num_rows($RegComanda);if ($totalRows_RegComanda > 0) {    $controlComandas = 1;}$a = 0;while ($row_RegComanda = mysqli_fetch_assoc($RegComanda)){    $encontrado = false;    $long = count($ArrayComandas);    for($conta=0; $conta< $long; $conta++) {        if ($ArrayComandas[$conta][1] == $row_RegComanda['idProductoComandaTemp']){            $ArrayComandas[$conta][0] = $ArrayComandas[$conta][0] + $row_RegComanda['cantidadComandaTemp'];            $ArrayComandas[$conta][1] = $row_RegComanda['idProductoComandaTemp'];            $ArrayComandas[$conta][2] = $ArrayComandas[$conta][2] + $row_RegComanda['totalComandaTemp'];            $encontrado = true;        }    }    if(!$encontrado){        $ArrayComandas[$a][0] = $row_RegComanda['cantidadComandaTemp'];        $ArrayComandas[$a][1] = $row_RegComanda['idProductoComandaTemp'];        $ArrayComandas[$a][2] = $row_RegComanda['totalComandaTemp'];        $a++;    }    }$query_RegMenu = "SELECT * FROM " . $tabla . " WHERE idGrupoMenuComandaTemp IS NOT NULL GROUP BY idGrupoMenuComandaTemp ORDER BY idMenuComandaTemp";$RegMenu = mysqli_query($comcon, $query_RegMenu) or die(mysqli_connect_error());$totalRows_RegMenu = mysqli_num_rows($RegMenu);if ($totalRows_RegMenu > 0) {    $control = 1;}$a = 0;while ($row_RegMenu = mysqli_fetch_assoc($RegMenu)){    $encontrado = false;    $long = count($ArrayMenus);    for($conta=0; $conta<= $long; $conta++) {        if ($ArrayMenus[$conta][1] == $row_RegMenu['idMenuComandaTemp']){            $ArrayMenus[$conta][0] = $ArrayMenus[$conta][0] + 1;            $ArrayMenus[$conta][1] = $row_RegMenu['idMenuComandaTemp'];            $ArrayMenus[$conta][2] = $ArrayMenus[$conta][2] + recuperaPrecioMenu($row_RegMenu['idMenuComandaTemp']);            $encontrado = true;        }    }    if(!$encontrado){        $ArrayMenus[$a][0] = 1;        $ArrayMenus[$a][1] = $row_RegMenu['idMenuComandaTemp'];        $ArrayMenus[$a][2] = recuperaPrecioMenu($row_RegMenu['idMenuComandaTemp']);        $a++;    }    }?><!DOCTYPE html><html>    <head>        <script type="text/javascript">            var idPedido = '';            var precioGlobal = '';            var mesa = <?php echo $idMesa ?>;            var nombreMesa = <?php echo recuperaNombreMesa($idMesa) ?>;            var tabla = '<?php echo $tabla; ?>';            var idVisitante = <?php echo $idVisitante; ?>;            var idNotificacion = <?php echo $idNotificacion; ?>;                        $("#keyboard").css("display","none");            $("#progress").css("display","none");            $("#divmesa").html('Mesa ' + nombreMesa);            $("#divfecha").html('Fecha: ' + fecha());            actualizaPrecioTemp();                        function irAtras(){                irA('notificacionesTpv.php');            }                        function fecha(){                var hoy = new Date();                var dd = hoy.getDate();                var mm = hoy.getMonth()+1; //hoy es 0!                var yyyy = hoy.getFullYear();                if(dd<10) {                    dd='0'+dd                }                 if(mm<10) {                    mm='0'+mm                }                 hoy = dd+'/'+mm+'/'+yyyy;                return hoy;            }            function actualizaPrecioTemp() {                var actualiza = {'tabla': tabla};                $.ajax({                    type: "POST",                    url: "../envCam/actualizaPrecioTemp.php",                    data: actualiza,                    success: function (data) {                        precioGlobal = data;                        var low = '';                        if (!isNaN(data)) {                            low = parseFloat(data).toFixed(2);                            if (isNaN(low)) {                                low = '0.00';                            }                            $("#divprecio").html(low + ' &euro;');                        } else {                            $('.toast').text('Error al actualizar');                            $('.toast').fadeIn(400).delay(2000).fadeOut(400);                        }                    }                });            }                        function borrarNotificacion(idVisitante){                var borrar = {'idVisitante': idVisitante};                $.ajax({                    type: "POST",                    async: true,                    url: "../envCam/borrarNotificacion.php",                    data: borrar,                    success: function (data) {                        if (data !== "OK") {                            $('.toast').text('Error al eliminar notificacion');                            $('.toast').fadeIn(400).delay(2000).fadeOut(400);                        }                    }                });                       }                        function checkChain(texto) {                var res = false;                if (/OKCORRECTO/.test(texto)) {                    res = true;                }                return res;            }            $(document).ready(function () {                $('#btnticket').click(function () {                    var paga = {'importe': precioGlobal, 'idMesa': mesa, 'idVisitante': idVisitante, 'idNotificacion': idNotificacion};                    $.ajax({                        type: "POST",                        url: "../envCam/cobrarPedidoTemp.php",                        data: paga,                        success: function (data) {                            var cadena = data.replace(/^\s+|\s+$/gm, '');                            if (checkChain(cadena)) {                                $('.toast').text('Se imprimio el ticket y se creo el pedido correctamente');                                $('.toast').fadeIn(400).delay(2000).fadeOut(400);                                borrarNotificacion(idVisitante);                                $("#pant").load(location.href + " #pant");                                document.getElementById('id00001').style.display = 'block';                            }else{                                $('.toast').text('Error al validar el pago');                                $('.toast').fadeIn(400).delay(2000).fadeOut(400);                            }                        }                    });                });            });        </script>    </head>    <body class="w3-light-grey">        <div class="w3-padding w3-display-middle" id="progress"><img src="page-loader.gif" width="100px" height="100px"></div>        <div class="userselect">            <div class="w3-container w3-card-4 w3-theme w3-padding-4" id="cap">                <div class="w3-left">                    <div class="w3-left w3-margin-top">                        <i class="material-icons w3-xlarge" onclick="irAtras();">&#xE5C4;</i>                    </div>                    <div class="w3-right w3-margin-left" style="margin-top: 8px;">                        <div id="divmesa" class="w3-xlarge"></div>                    </div>                </div>                <div class="w3-right">                    <div id="divprecio" class="w3-xxlarge"></div>                </div>            </div>            <div class="w3-row w3-theme-l2 w3-large w3-margin-top">                <div style="width:10%;float: left;padding-left: 10px;">Uds.</div>                <div style="width:70%;float: left;padding-left: 25px;">Producto</div>                <div style="width:20%;float: left;padding-left: 5px;">Precio</div>            </div>            <div style="overflow: scroll;height: 340px;" id="">                <?php if ($controlComandas > 0 || $control == 1) { ?>                    <table class="w3-table w3-border w3-margin-top w3-large  w3-bordered w3-striped w3-hoverable">                        <?php                        if ($controlComandas == 1) {                            $longitud = count($ArrayComandas);                            for($cont=0; $cont<$longitud; $cont++) {                                $nomProduct = $ArrayComandas[$cont][1];                                $cant = $ArrayComandas[$cont][0];                                ?>                                <tr>                                    <td><?php echo $cant; ?></td>                                    <td><?php echo utf8_encode(recuperaNombreProducto($nomProduct)); ?></td>                                    <td style="text-align: right;padding-right: 12px;"><?php echo number_format($ArrayComandas[$cont][2], 2); ?>&euro;</td>                                </tr>                        <?php }                        }                        ?>                        <?php                        if ($control == 1) {                            $l= count($ArrayMenus);                            for($co=0; $co<$l; $co++)  {                                $nomMenu = recuperaNombreMenu($ArrayMenus[$co][1]);                                ?>                                <tr>                                    <td><?php echo $ArrayMenus[$co][0]; ?></td>                                    <td><?php echo utf8_encode($nomMenu); ?></td>                                    <td style="text-align: right;padding-right: 12px;"><?php echo number_format($ArrayMenus[$co][2], 2); ?>&euro;</td>                                </tr>                         <?php }                        } ?>                        </table>                        <?php } else { ?><br><div class="w3-container w3-section w3-large w3-padding-large w3-theme-l2 w3-center">NO EXISTEN LINEAS PARA ESTE TICKET</div><?php }?>            </div>            <div class="w3-container w3-padding-0" style="">                <div class="w3-row w3-small w3-padding-small">                    <div id="divfecha" class="w3-large"></div>                    AL IMPRIMIR EL TICKET SE VALIDARA EL COBRO                </div>                <div class="w3-row" style="margin-bottom: 3px;">                    <div class="w3-center" style="width: 50%;float: left;">                        <button class="w3-btn w3-theme w3-xlarge" style="width: 98%;" id="btnticket">TICKET</button>                    </div>                    <div class="w3-center" style="width: 50%;float: right;">                        <button class="w3-btn w3-theme w3-xlarge" style="width: 98%;" id="" onclick="irAtras();">VOLVER</button>                    </div>                </div>                <!--<div class="w3-row" style="margin-bottom: 3px;">                    <div class="w3-center" style="width: 100%;">                        <button class="w3-btn w3-theme w3-xlarge" style="width: 98%;" id="" onclick="irA('forzarImporteTpv.php?ref=0&precio='+precioGlobal+'&idPedido='+idPedido+'&idMesa='+mesa);">FORZAR IMPORTE</button>                    </div>                </div>-->            </div>                        <div id="id00001" class="w3-modal">                <div class="w3-modal-content w3-card-8 w3-round-medium" style="top: 80px;width: 40%;margin-left: 30%;">                    <header class="w3-container w3-theme-l2">                        <span onclick="document.getElementById('id01').style.display = 'none'"                              class="w3-closebtn">&times;</span>                        <h4>PEDIDO COBRADO</h4>                    </header>                    <div class="w3-container w3-large w3-margin w3-center">                        EL COBRO SE HA REALIZADO CORRECTAMENTE Y SE HA VALIDADO EL PEDIDO                        <div class="w3-margin-top w3-margin-bottom">                            <button class="w3-btn w3-xlarge w3-theme" style="width: 60%;height: 90px;" id="" onclick="irA('seleccionTpv.php')">ACEPTAR</button>                        </div>                    </div>                </div>            </div>        </div>    </body></html><?phpmysqli_free_result($RegComanda);mysqli_free_result($RegPedido);?>