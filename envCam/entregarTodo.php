<?phprequire_once('../Connections/conexionComanderEnvCam.php');require_once('../includes/funcionesEnvCam.php');if (!isset($_SESSION)) {  session_start();}$MM_authorizedUsers = "3,2,1";$MM_donotCheckaccess = "false";include '../includes/restriccionCam.php';date_default_timezone_set("Europe/Madrid");$hora = date("H:i");if (isset($_POST['idPedido'])){    $idPedido = $_POST['idPedido'];    mysqli_select_db($comcon, $database_comcon);    $query_RegComanda = "SELECT idComanda, cantidadPedidaComanda, cantidadEntregaComanda, cantidadPreparadaComanda, idProductoComanda FROM comandas WHERE idPedidoComanda=".$idPedido." AND cantidadEntregaComanda=0";    $RegComanda = mysqli_query($comcon, $query_RegComanda) or die(mysqli_connect_error());    $row_RegComanda = mysqli_fetch_assoc($RegComanda);    $totalRows_RegComanda = mysqli_num_rows($RegComanda);    if ($totalRows_RegComanda > 0){        do{            if($row_RegComanda['cantidadEntregaComanda'] != 0){                $cantidad = $row_RegComanda['cantidadEntregaComanda'];            }else{                $cantidad = $row_RegComanda['cantidadPedidaComanda'];            }            $idComanda = $row_RegComanda['idComanda'];            $cantidadPedida = $row_RegComanda['cantidadPedidaComanda'];            $totalComanda = recuperaPrecio($row_RegComanda['idProductoComanda'])*$cantidad;            $updateSQL = "UPDATE comandas SET cantidadEntregaComanda=$cantidadPedida, totalComanda=$totalComanda,"                        . "horaComandaEntregada='$hora' WHERE idComanda=$idComanda";            $Result1 = mysqli_query($comcon, $updateSQL) or die(mysqli_connect_error());        } while ($row_RegComanda = mysqli_fetch_assoc($RegComanda));    }        //COMPROBAMOS QUE NO QUEDAN COMANDAS POR ENTREGAR    $consulta = "SELECT idComanda FROM comandas WHERE idPedidoComanda=" . $idPedido . " AND cantidadEntregaComanda=0";    $resultado = mysqli_query($comcon, $consulta) or die(mysqli_connect_error());    if (mysqli_num_rows($resultado) == 0){        $query_CompruebaPedidoPagado = "SELECT estadoCobroPedido FROM pedidos WHERE idPedido=".$idPedido;        $CompruebaPedidoPagado = mysqli_query($comcon, $query_CompruebaPedidoPagado) or die(mysqli_connect_error());        $row_CompruebaPedidoPagado = mysqli_fetch_assoc($CompruebaPedidoPagado);        if ($row_CompruebaPedidoPagado['estadoCobroPedido'] == 1){           $updatePedidosentregado = "UPDATE pedidos SET estadoEntregadoPedido=1, estadoMesaPedido=0 WHERE idPedido=$idPedido";         }else{           $updatePedidosentregado = "UPDATE pedidos SET estadoEntregadoPedido=1 WHERE idPedido=$idPedido";         }        $Result1 = mysqli_query($comcon, $updatePedidosentregado) or die(mysqli_connect_error());    }    echo "OK";}?>