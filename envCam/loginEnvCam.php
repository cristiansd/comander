<?php//require_once('../includes/funcionesEnvCam.php');// *** Validate request to login to this site.if (!isset($_SESSION)) {    session_start();}$loginFormAction = $_SERVER['PHP_SELF'];if (isset($_GET['accesscheck'])) {    $_SESSION['PrevUrl'] = $_GET['accesscheck'];}$contra = $_GET['contra'];$nickBidi = $_GET['nickBidi'];$idEstablecimiento = $_GET['idEstablecimiento'];$idDevice = $_GET['idDevice'];$hostname_main = "localhost";$database_main = "eh1w1ia3_main";$username_main = "eh1w1ia3_sangar";$password_main = "290172crissan";$conn_main = mysqli_connect($hostname_main, $username_main, $password_main) or trigger_error(mysqli_connect_error(),E_USER_ERROR);mysqli_select_db($conn_main, $database_main);//RECUPERAMOS DATOS DE CONEXION$establecimiento__query="SELECT hostname_database, name_database, username_database,password_database,nombre_establecimiento, direction FROM establecimientos WHERE id_establecimiento='$idEstablecimiento'";$establecimientoRS = mysqli_query($conn_main, $establecimiento__query) or die(mysqli_connect_error());  $establecimientoRS_rows = mysqli_fetch_array($establecimientoRS);$totalRows_establecimientoRS = mysqli_num_rows($establecimientoRS);if ($totalRows_establecimientoRS > 0){    $hostname_local = $establecimientoRS_rows['hostname_database'];    $database_local = $establecimientoRS_rows['name_database'];    $username_local = $establecimientoRS_rows['username_database'];    $password_local = $establecimientoRS_rows['password_database'];    $nombre_local = $establecimientoRS_rows['nombre_establecimiento'];    $direccion = $establecimientoRS_rows['direction'];   }else{    header('location:errorLocalEnvCam.php');}//CREAMOS NUEVA CONEXION CON LOS DATOS RECUPERADOS$conn_local = mysqli_connect($hostname_local, $username_local, $password_local) or trigger_error(mysqli_connect_error(),E_USER_ERROR);mysqli_select_db($conn_local, $database_local);//RECUPERAMOS DATOS DEL USUARIO EN EL LOCAL$LoginRS__query = "SELECT idUsuario, nickUsuario, nombreUsuario, nivelPermisoUsuario FROM usuarios WHERE nickUsuario='$nickBidi' AND passwordUsuario='$contra'";$LoginRS = mysqli_query($conn_local, $LoginRS__query);$LoginRS_rows = mysqli_fetch_array($LoginRS);$loginFoundUser = mysqli_num_rows($LoginRS);//COMPROBAMOS SI EL USUARIO ESTA EN EL LOCALif ($loginFoundUser) {        $loginStrGroup = $LoginRS_rows['nivelPermisoUsuario'];        if (PHP_VERSION >= 5.1) {        session_regenerate_id(true);    } else {        session_regenerate_id();    }    //DECLARAMOS VARIABLES DE SESION DEL USUARIO    $_SESSION['MM_idUser'] = $LoginRS_rows['idUsuario'];    $_SESSION['MM_Username'] = $LoginRS_rows['nickUsuario'];    $_SESSION['nombreUsuario'] = $LoginRS_rows['nombreUsuario'];    $_SESSION['MM_UserGroup'] = $loginStrGroup;    $_SESSION['idEstablecimiento'] = $idEstablecimiento;    $_SESSION['nombre_local'] = $nombre_local;    $_SESSION['direccion'] = $direccion;        //DECLARAMOS VARIABLES DE SESION PARA LA CONEXION    $_SESSION['hostname_database'] = $hostname_local;    $_SESSION['name_database'] = $database_local;    $_SESSION['username_database'] = $username_local;    $_SESSION['password_database'] = $password_local;        //CAMBIAMOS ESTADO DE USUARIO A ACTIVO Y VINCULAMOS A UN IDDEVICE    $updateSQL = "UPDATE usuarios SET estadoUsuario=1, idDevice=".$idDevice." WHERE nickUsuario='$nickBidi' AND passwordUsuario='$contra'";    $Result = mysqli_query($conn_local, $updateSQL) or die(mysqli_connect_error());        //REDIRECCIONAMOS SI CORRECTO LOGIN    $url = 'principalEnvCam.php';    } else {        //REDIRECCIONAMOS SI ERROR LOGIN    $url = 'errorIdentificacionEnvCam.php';    }header('location:'.$url);?><!DOCTYPE html> <html>    <head>        <title>Scanner</title>        <meta charset="UTF-8">        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, user-scalable=no">        <!--<link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">-->        <link rel="stylesheet" href="../estilos/w3.css">        <style type="text/css">            .loader {                position: fixed;                left: 0px;                top: 0px;                width: 100%;                height: 100%;                z-index: 9999;                background-color: #3f51b5;            }        </style>        <script type="text/javascript" src="jquery-mobile/jquery.js"></script>        <script type="text/javascript">            $(window).load(function () {                //$(".loader").fadeOut("fast");            });        </script>    </head>    <body>        <div class="loader"></div>        <div class="w3-padding w3-display-middle" id="progress"><img src="page-loader.gif" width="100px" height="100px"></div>    </body></html>