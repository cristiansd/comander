<?phprequire_once('../Connections/conexionComanderEnvCam.php');require_once('../includes/funcionesEnvCam.php');if (!isset($_SESSION)) {    session_start();}$MM_authorizedUsers = "3,2,1";$MM_donotCheckaccess = "false";include '../includes/restriccionCam.php';if (!isset($_GET['idPedido'])){    header('Location:principalEnvCam.php');}else{    $idPedido = $_GET['idPedido'];    $control = 0;    $controlComandas = 0;    $ArrayComandas = Array();    $ArrayMenus = Array();    mysqli_select_db($comcon, $database_comcon);    $query_RegPedido = "SELECT * FROM pedidos WHERE idPedido=" . $idPedido;    $RegPedido = mysqli_query($comcon, $query_RegPedido) or die(mysql_connect_error());    $row_RegPedido = mysqli_fetch_assoc($RegPedido);    $totalRows_RegPedido = mysqli_num_rows($RegPedido);    $idMesa = $row_RegPedido['idMesaPedido'];    if ($row_RegPedido['estadoCobroPedido'] == 1){       header('Location:principalEnvCam.php');     }    $query_RegComanda = "SELECT * FROM comandas WHERE estadoCerradoComanda=0 AND cantidadEntregaComanda > 0 AND idGrupoMenuComanda IS NULL AND idPedidoComanda=" . $idPedido;    $RegComanda = mysqli_query($comcon, $query_RegComanda) or die(mysqli_connect_error());    $totalRows_RegComanda = mysqli_num_rows($RegComanda);    if ($totalRows_RegComanda > 0) {        $controlComandas = 1;    }    $a = 0;    while ($row_RegComanda = mysqli_fetch_assoc($RegComanda)){        $encontrado = false;        $long = count($ArrayComandas);        for($conta=0; $conta< $long; $conta++) {            if ($ArrayComandas[$conta][1] == $row_RegComanda['idProductoComanda']){                $ArrayComandas[$conta][0] = $ArrayComandas[$conta][0] + $row_RegComanda['cantidadEntregaComanda'];                $ArrayComandas[$conta][1] = $row_RegComanda['idProductoComanda'];                $ArrayComandas[$conta][2] = $ArrayComandas[$conta][2] + $row_RegComanda['totalComanda'];                $encontrado = true;            }        }        if(!$encontrado){            $ArrayComandas[$a][0] = $row_RegComanda['cantidadEntregaComanda'];            $ArrayComandas[$a][1] = $row_RegComanda['idProductoComanda'];            $ArrayComandas[$a][2] = $row_RegComanda['totalComanda'];            $a++;        }        }    $query_RegMenu = "SELECT * FROM comandas WHERE estadoCerradoComanda=0 AND idGrupoMenuComanda IS NOT NULL AND idPedidoComanda=" . $idPedido . " GROUP BY idGrupoMenuComanda ORDER BY idMenuProductosComanda";    $RegMenu = mysqli_query($comcon, $query_RegMenu) or die(mysqli_connect_error());    $totalRows_RegMenu = mysqli_num_rows($RegMenu);    if ($totalRows_RegMenu > 0) {        $control = 1;    }    $a = 0;    while ($row_RegMenu = mysqli_fetch_assoc($RegMenu)){        $encontrado = false;        $long = count($ArrayMenus);        for($conta=0; $conta<= $long; $conta++) {            if ($ArrayMenus[$conta][1] == $row_RegMenu['idMenuProductosComanda']){                $ArrayMenus[$conta][0] = $ArrayMenus[$conta][0] + 1;                $ArrayMenus[$conta][1] = $row_RegMenu['idMenuProductosComanda'];                $ArrayMenus[$conta][2] = $ArrayMenus[$conta][2] + recuperaPrecioMenu($row_RegMenu['idMenuProductosComanda']);                $encontrado = true;            }        }        if(!$encontrado){            $ArrayMenus[$a][0] = 1;            $ArrayMenus[$a][1] = $row_RegMenu['idMenuProductosComanda'];            $ArrayMenus[$a][2] = recuperaPrecioMenu($row_RegMenu['idMenuProductosComanda']);            $a++;        }        }}?><!DOCTYPE html><html>    <head>        <meta charset="utf-8">        <title>Ver categorias</title>        <script type="text/javascript" src="jquery-mobile/jquery.js"></script>        <style type="text/css">            .userselect {                -webkit-user-select: none;  /* Chrome all / Safari all */                -moz-user-select: none;     /* Firefox all */                -ms-user-select: none;      /* IE 10+ */                user-select: none;          /* Likely future */            }            .toast {                width:360px;                height:20px;                height:auto;                position:absolute;                left:50%;                margin-left:-180px;                bottom:110px;                background-color: #383838;                color: #F0F0F0;                font-family: Calibri;                font-size: 20px;                padding:10px;                text-align:center;                border-radius: 5px;                -webkit-box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);                -moz-box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);                box-shadow: 0px 0px 24px -1px rgba(56, 56, 56, 1);            }            .pantalla {            }        </style>        <meta name="viewport" content="width=device-width, initial-scale=1">        <!--<link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">-->        <link rel="stylesheet" href="../estilos/w3.css">        <link rel="stylesheet" href="../estilos/w3-theme-indigo.css">        <!--<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->        <link rel="stylesheet" href="..\font-awesome-4.7.0\css\font-awesome.min.css">        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">        <script type="text/javascript" src="js/location.js"></script>        <script type="text/javascript">            var idPedido = getParameterByName('idPedido');            var precioGlobal = '';            var mesa = <?php echo $idMesa ?>;            var nombreMesa = <?php echo recuperaNombreMesa($idMesa) ?>;            $(window).load(function () {                $("#progress").css("display","none");                $("#textonav").html("PEDIDO");                $('.pantalla').height($(window).height() - 280);                $("#divmesa").html('Mesa ' + nombreMesa);                $("#divpedido").html('Pedido: ' + idPedido);                $("#divfecha").html('Fecha: ' + fecha());                actualizaPrecio();            });                        function irAtras(){                location.href='listaTiempoRealEnvCam.php?idPedido='+idPedido;            }            function getParameterByName(name) {                name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");                var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),                        results = regex.exec(location.search);                return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));            }                        function fecha(){                var hoy = new Date();                var dd = hoy.getDate();                var mm = hoy.getMonth()+1; //hoy es 0!                var yyyy = hoy.getFullYear();                if(dd<10) {                    dd='0'+dd                }                 if(mm<10) {                    mm='0'+mm                }                 hoy = dd+'/'+mm+'/'+yyyy;                return hoy;            }            function actualizaPrecio() {                var actualiza = {'idPedido': idPedido, 'check': 1};                $.ajax({                    type: "POST",                    url: "actualizaPrecio.php",                    data: actualiza,                    success: function (data) {                        precioGlobal = data;                        var low = '';                        if (!isNaN(data)) {                            low = parseFloat(data).toFixed(2);                            if (isNaN(low)) {                                low = '0.00';                            }                            $("#divprecio").html(low + ' &euro;');                        } else {                            $('.toast').text('Error al actualizar');                            $('.toast').fadeIn(400).delay(2000).fadeOut(400);                        }                    }                });            }            $(document).ready(function () {                $('#btnticket').click(function () {                    $("#progress").css("display","block");                    var paga = {'idPedido': idPedido, 'precioTotal': precioGlobal};                    $.ajax({                        type: "POST",                        url: "cobrarPedido.php",                        data: paga,                        success: function (data) {                            var cadena = data.replace(/^\s+|\s+$/gm, '');                            if (cadena === 'OK') {                                $("#progress").css("display","none");                                $('.toast').text('Se imprimio el ticket y se validó el cobro correctamente');                                $('.toast').fadeIn(400).delay(2000).fadeOut(400);                                document.getElementById('id01').style.display = 'block';                            }else{                                $('.toast').text('Error al validar el pago');                                $('.toast').fadeIn(400).delay(2000).fadeOut(400);                            }                        }                    });                });            });        </script>    </head>    <body class="w3-light-grey">        <div class="w3-padding w3-display-middle" id="progress"><img src="page-loader.gif" width="100px" height="100px"></div>        <div class="userselect">            <header class="w3-container w3-card-4 w3-theme w3-padding-4 w3-top" id="cap">                <div class="w3-left">                    <div class="w3-left w3-margin-top">                        <i class="material-icons w3-xlarge" onclick="irAtras();">&#xE5C4;</i>                    </div>                    <div class="w3-right w3-margin-left">                        <div id="divmesa" class="w3-xlarge"></div>                        <div id="divpedido" class="w3-medium"></div>                    </div>                </div>                <div class="w3-right">                    <div id="divprecio" class="w3-xxlarge"></div>                </div>            </header>            <div id="notify" class="w3-card-4 w3-panel w3-yellow w3-center w3-large w3-padding-8 w3-border w3-border-red" style="display: none;position: fixed;top: 45px;width: 100%;" onclick="window.location.href = '../envCam/notificacionesEnvCam.php';">                ¡¡¡NOTIFICACIONES PENDIENTES!!!            </div>            <br><br><br>            <div class="w3-row w3-theme-l2 w3-large w3-margin-top">                <div style="width:10%;float: left;padding-left: 10px;">Uds.</div>                <div style="width:70%;float: left;padding-left: 25px;">Producto</div>                <div style="width:20%;float: left;padding-left: 5px;">Precio</div>            </div>            <div  class="pantalla" style="overflow: scroll;" id="pant">                <?php if ($controlComandas > 0 || $control == 1) { ?>                    <table class="w3-table w3-border w3-margin-top w3-large  w3-bordered w3-striped w3-hoverable">                        <?php                        if ($controlComandas == 1) {                            $longitud = count($ArrayComandas);                            for($cont=0; $cont<$longitud; $cont++) {                                $nomProduct = $ArrayComandas[$cont][1];                                $cant = $ArrayComandas[$cont][0];                                ?>                                <tr>                                    <td><?php echo $cant; ?></td>                                    <td><?php echo recuperaNombreProducto($nomProduct); ?></td>                                    <td style="text-align: right;padding-right: 12px;"><?php echo number_format($ArrayComandas[$cont][2], 2); ?>&euro;</td>                                </tr>                        <?php }                        }                        ?>                        <?php                        if ($control == 1) {                            $l= count($ArrayMenus);                            for($co=0; $co<$l; $co++)  {                                $nomMenu = recuperaNombreMenu($ArrayMenus[$co][1]);                                ?>                                <tr>                                    <td><?php echo $ArrayMenus[$co][0]; ?></td>                                    <td><?php echo $nomMenu; ?></td>                                    <td style="text-align: right;padding-right: 12px;"><?php echo number_format($ArrayMenus[$co][2], 2); ?>&euro;</td>                                </tr>                         <?php }                        } ?>                        </table>                        <?php } else { ?><br><div class="w3-container w3-section w3-large w3-padding-large w3-theme-l2 w3-center">NO EXISTEN LINEAS PARA ESTE TICKET</div><?php }?>            </div>            <footer class="w3-container w3-bottom w3-padding-0" style="bottom: 5px;">                <div class="w3-row w3-small w3-padding-small">                    <div id="divfecha" class="w3-large"></div>                    AL IMPRIMIR EL TICKET SE VALIDARA EL COBRO                </div>                <div class="w3-row" style="margin-bottom: 3px;">                    <div class="w3-center" style="width: 50%;float: left;">                        <button class="w3-btn w3-theme w3-xlarge" style="width: 98%;" id="btnticket">TICKET</button>                    </div>                    <div class="w3-center" style="width: 50%;float: right;">                        <button class="w3-btn w3-theme w3-xlarge" style="width: 98%;" id="" onclick="irAtras();">VOLVER</button>                    </div>                </div>            </footer>                        <div id="id01" class="w3-modal">                <div class="w3-modal-content w3-card-8 w3-round-medium" style="top: 80px;">                    <header class="w3-container w3-theme-l2">                        <span onclick="document.getElementById('id01').style.display = 'none'"                              class="w3-closebtn">&times;</span>                        <h4>PEDIDO COBRADO</h4>                    </header>                    <div class="w3-container w3-large w3-margin w3-center">                        EL COBRO SE HA REALIZADO CORRECTAMENTE Y SE HA VALIDADO EL PEDIDO                        <div class="w3-margin-top w3-margin-bottom">                            <button class="w3-btn w3-xlarge w3-theme" style="width: 100%;" id="" onclick="ir('principalEnvCam.php')">ACEPTAR</button>                        </div>                    </div>                </div>            </div>                        <div class='toast' style='display:none'>TOAST</div>        </div>    </body></html><?phpmysqli_free_result($RegComanda);mysqli_free_result($RegPedido);?>