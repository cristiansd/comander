<?php require_once('../Connections/conexionComanderEnvCam.php');require_once('../includes/funcionesEnvCam.php');require('../classes/fpdf181/fpdf.php');if (!isset($_SESSION)) {  session_start();}$MM_authorizedUsers = "3,2,1";$MM_donotCheckaccess = "false";include '../includes/restriccionCam.php';class PDF extends FPDF {        function consulta($pedido) {        define('EURO',chr(128));                $precioTotal = 0;        $control = 0;        $controlComandas = 0;        $ArrayComandas = Array();        $ArrayMenus = Array();                $hostname_comcon = $_SESSION['hostname_database'];        $database_comcon = $_SESSION['name_database'];        $username_comcon = $_SESSION['username_database'];        $password_comcon = $_SESSION['password_database'];        $comcon = mysqli_connect($hostname_comcon, $username_comcon, $password_comcon) or trigger_error(mysqli_error(),E_USER_ERROR);        mysqli_select_db($comcon, $database_comcon);                //COMANDAS        $query_RegComanda = "SELECT * FROM comandas WHERE idPedidoComanda = $pedido AND cantidadEntregaComanda > 0 AND idGrupoMenuComanda IS NULL";        $RegComanda = mysqli_query($comcon, $query_RegComanda) or die(mysqli_connect_error());        $totalRows_RegComanda = mysqli_num_rows($RegComanda);        if ($totalRows_RegComanda > 0) {            $controlComandas = 1;        }                $a = 0;        while ($row_RegComanda = mysqli_fetch_assoc($RegComanda)){            $encontrado = false;            $long = count($ArrayComandas);            for($conta=0; $conta< $long; $conta++) {                if ($ArrayComandas[$conta][1] == $row_RegComanda['idProductoComanda']){                    $ArrayComandas[$conta][0] = $ArrayComandas[$conta][0] + $row_RegComanda['cantidadEntregaComanda'];                    $ArrayComandas[$conta][1] = $row_RegComanda['idProductoComanda'];                    $ArrayComandas[$conta][2] = $ArrayComandas[$conta][2] + $row_RegComanda['totalComanda'];                    $encontrado = true;                }            }            if(!$encontrado){                $ArrayComandas[$a][0] = $row_RegComanda['cantidadEntregaComanda'];                $ArrayComandas[$a][1] = $row_RegComanda['idProductoComanda'];                $ArrayComandas[$a][2] = $row_RegComanda['totalComanda'];                $a++;            }            }                        //MENUS        $query_RegMenu = "SELECT * FROM comandas WHERE idGrupoMenuComanda IS NOT NULL AND idPedidoComanda=" . $pedido . " GROUP BY idGrupoMenuComanda ORDER BY idMenuProductosComanda";        $RegMenu = mysqli_query($comcon, $query_RegMenu) or die(mysqli_connect_error());        $totalRows_RegMenu = mysqli_num_rows($RegMenu);        if ($totalRows_RegMenu > 0) {            $control = 1;        }        $a = 0;        while ($row_RegMenu = mysqli_fetch_assoc($RegMenu)){            $encontrado = false;            $long = count($ArrayMenus);            for($conta=0; $conta<= $long; $conta++) {                if ($ArrayMenus[$conta][1] == $row_RegMenu['idMenuProductosComanda']){                    $ArrayMenus[$conta][0] = $ArrayMenus[$conta][0] + 1;                    $ArrayMenus[$conta][1] = $row_RegMenu['idMenuProductosComanda'];                    $query_RegPrecio = "SELECT precioMenu FROM menus WHERE idMenu=" . $row_RegMenu['idMenuProductosComanda'];                    $RegPrecio = mysqli_query($comcon, $query_RegPrecio) or die(mysql_connect_error());                    $row_RegPrecio = mysqli_fetch_assoc($RegPrecio);                    $precio = $row_RegPrecio['precioMenu'];                    $ArrayMenus[$conta][2] = $ArrayMenus[$conta][2] + $precio;                    $encontrado = true;                }            }            if(!$encontrado){                $ArrayMenus[$a][0] = 1;                $ArrayMenus[$a][1] = $row_RegMenu['idMenuProductosComanda'];                $query_RegPrecio = "SELECT precioMenu FROM menus WHERE idMenu=" . $row_RegMenu['idMenuProductosComanda'];                $RegPrecio = mysqli_query($comcon, $query_RegPrecio) or die(mysql_connect_error());                $row_RegPrecio = mysqli_fetch_assoc($RegPrecio);                $precio = $row_RegPrecio['precioMenu'];                $ArrayMenus[$a][2] = $precio;                $a++;            }            }                //REALIZAMOS CONSULTA DE LA ULTIMA FACTURA PARA OBTENER EL NUMERO        $consulta_factura = "SELECT numero_factura FROM facturas ORDER BY id DESC";        $consulta_factura_query = mysqli_query($comcon, $consulta_factura) or die(mysql_connect_error());        $row_consulta_factura = mysqli_fetch_array($consulta_factura_query);                //ASIGNAMOS LOS DATOS OBTENIDOS A VARIABLES        $numeroFactura = $row_consulta_factura['0'] + 1;                //REALIZAMOS CONSULTA DE LA SUMA DEL PEDIDO        $result = mysqli_query($comcon, "SELECT SUM(totalComanda) as total FROM comandas");	        $row = mysqli_fetch_array($result, MYSQL_ASSOC);        $pedidoTotal = $row["total"].EURO;                //DECLARAMOS LOS VALORES PARA LA CONEXION A LA BD        $hostname_main = "localhost";        $database_main = "eh1w1ia3_main";        $username_main = "eh1w1ia3_sangar";        $password_main = "290172crissan";        $conn_main = mysqli_connect($hostname_main, $username_main, $password_main) or trigger_error(mysqli_connect_error(), E_USER_ERROR);        mysqli_select_db($conn_main, $database_main);                //DECLARAMOS LAS VARIABLES NECESARIAS        $id_establecimiento = $_SESSION['idEstablecimiento'];                //REALIZAMOS CONSULTA DE LOS DATOS DEL LOCAL        $consulta_local = "SELECT nombre_establecimiento, nombre_fiscal, CIF, direction, iva FROM establecimientos WHERE id_establecimiento = '$id_establecimiento'";        $consulta_local_query = mysqli_query($conn_main, $consulta_local) or die(mysql_connect_error());        $row_consulta_local = mysqli_fetch_array($consulta_local_query);                //ASIGNAMOS LAS VARIABLES CONSULTADAS        $nombreEstablecimiento = utf8_decode($row_consulta_local['nombre_establecimiento']);        $nombreFiscal = utf8_decode($row_consulta_local['nombre_fiscal']);        $cif = $row_consulta_local['CIF'];        $direccion = utf8_decode($row_consulta_local['direction']);                $iva = $row_consulta_local['iva'];        $textoIva = "I.V.A del ".$iva." % incluido";                //Instaciamos la clase para genrear el documento pdf        $pdf = new FPDF();        //Agregamos la primera pagina al documento pdf        $pdf->AddPage();        //CUERPO        //Seteamos el tiupo de letra y creamos el titulo de la pagina. No es un encabezado no se repetira        $pdf->SetFont('Arial', 'B', 18);        $pdf->Cell(185, 6, $nombreEstablecimiento, 0, 0, 'L');        $pdf->Ln(10);        $pdf->SetFont('Arial', 'B', 12);        $pdf->Cell(185, 6, $nombreFiscal, 0, 0, 'L');        $pdf->Ln(5);        $pdf->Cell(20, 6, 'CIF/NIF: ', 0, 0, 'L');        $pdf->Cell(20, 6, $cif, 0, 0, 'L');        $pdf->Ln(5);        $pdf->Cell(30, 6, 'DIRECCION: ', 0, 0, 'L');        $pdf->Cell(155, 6, $direccion, 0, 0, 'L');        $pdf->Ln(5);        $pdf->Cell(55, 6, 'FACTURA SIMPLIFICADA: ', 0, 0, 'L');        $pdf->Cell(20, 6, $numeroFactura, 0, 0, 'L');        $pdf->Ln(5);        $pdf->Cell(20, 6, 'FECHA: ', 0, 0, 'L');        $pdf->Cell(20, 6, date('d/m/Y'), 0, 0, 'L');        $pdf->Ln(10);//Creamos las celdas para los titulo de cada columna y le asignamos un fondo gris y el tipo de letra        $pdf->SetFillColor(232, 232, 232);        $pdf->SetFont('Arial', 'B', 10);        $pdf->Cell(125, 6, 'Producto', 1, 0, 'C', 1);        $pdf->Cell(30, 6, 'Cantidad', 1, 0, 'C', 1);        $pdf->Cell(30, 6, 'Total', 1, 0, 'C', 1);        $pdf->Ln(10);                if ($controlComandas > 0 || $control == 1) {                        if ($controlComandas == 1) {                $longitud = count($ArrayComandas);                for($cont=0; $cont<$longitud; $cont++) {                    $nomProduct = $ArrayComandas[$cont][1];                    $cant = $ArrayComandas[$cont][0];                    $precioTotal = $precioTotal + $ArrayComandas[$cont][2];                                        $query_RegProducto = "SELECT nombreProducto FROM productos WHERE idProducto=" . $ArrayComandas[$cont][1];;                    $RegProducto = mysqli_query($comcon, $query_RegProducto) or die(mysql_connect_error());                    $row_RegProducto = mysqli_fetch_assoc($RegProducto);                    $producto = $row_RegProducto['nombreProducto'];                    $total = number_format($ArrayComandas[$cont][2], 2). " " .EURO;                                        $pdf->Cell(125, 15, $producto, 1, 0, 'L', 0);                    $pdf->Cell(30, 15, $cant, 1, 0, 'C', 1);                    $pdf->Cell(30, 15, $total, 1, 0, 'C', 1);                        $pdf->Ln(15);                                    }               }                        if ($control == 1) {                $l= count($ArrayMenus);                for($co=0; $co<$l; $co++)  {                    $precioTotal = $precioTotal + $ArrayMenus[$co][2];                    $query_RegMenu = "SELECT nombreMenu FROM menus WHERE idMenu=" . $ArrayMenus[$co][1];                    $RegMenu = mysqli_query($comcon, $query_RegMenu) or die(mysqli_connect_error());                    $row_RegMenu = mysqli_fetch_assoc($RegMenu);                    $nomMenu = $row_RegMenu['nombreMenu'];                    $totalMenus = number_format($ArrayMenus[$co][2], 2). " " .EURO;                                        $pdf->Cell(125, 15, $nomMenu, 1, 0, 'L', 0);                    $pdf->Cell(30, 15, $ArrayMenus[$co][0], 1, 0, 'C', 1);                    $pdf->Cell(30, 15, $totalMenus, 1, 0, 'C', 1);                        $pdf->Ln(15);                 }            }          }                $pdf->Cell(125, 15, '', 0, 0, 'L', 0);        $pdf->Cell(30, 15, 'TOTAL PEDIDO', 1, 0, 'C', 1);        $pdf->Cell(30, 15, number_format($precioTotal, 2). " " .EURO, 1, 0, 'C', 1);        $pdf->Ln(5);        $pdf->Cell(185, 6, $textoIva, 0, 0, 'L');        $documento = '../Usuario/tiquets/pedido_'.$pedido.'.pdf';        $pdf->Output($documento,'F');                //GENERAMOS LA SUBIDA DEL PDF A LA BD DEL LOCAL        //CODIFICAMOS LA IMAGEN EN BINARIO PARA SUBIRLA A LA BASE DE DATOS        $tipo = "application/pdf";        $fd = fopen ($documento, "r");        while(!feof($fd)) {            $buffer = fread($fd, 2048);            $imagen = addslashes($buffer);        }        //CALCULAMOS EL IVA Y LA BASE IMPONIBLE        $operadorIva = '1.'.$iva;        $ivaOperacion = floatval($operadorIva);         $base_imponible = round(($precioTotal/$ivaOperacion), 2);           $iva_del_total = $precioTotal - $base_imponible;        $fecha = date('Y-m-d');        //INSERTAMOS NUEVA FACTURA EN LA TABLA FACTURAS DEL LOCAL        mysqli_select_db($comcon, $database_comcon);        $insert_factura = "INSERT INTO facturas (numero_factura, base_imponible, tipo_iva, fecha, iva, total, pdf, tipo_pdf) VALUES ('$numeroFactura', '$base_imponible', '$iva', '$fecha', '$iva_del_total', '$precioTotal', '$imagen', '$tipo')";                ;        mysqli_query($comcon, $insert_factura) or die(mysqli_connect_error());        }  }date_default_timezone_set("Europe/Madrid");//DECLARAMOS UN PDF, AÑADIMOS UNA PAGINA Y DECLARAMOS EL TIPO DE LETRA Y TAMAÑO$pdf=new PDF();$fecha = date("Y-m-d");$hora = date("H:i");if (isset($_POST['idPedido'])){    $idPedido = $_POST['idPedido'];    $precioTotal = $_POST['precioTotal'];    mysqli_select_db($comcon, $database_comcon);    $updateComandas = "UPDATE comandas SET estadoCerradoComanda=1 WHERE idPedidoComanda=$idPedido";    $Result1 = mysqli_query($comcon, $updateComandas) or die(mysqli_connect_error());    $query_CompruebaPedidoEntregado = "SELECT estadoEntregadoPedido FROM pedidos WHERE idPedido=".$idPedido;    $CompruebaPedidoEntregado = mysqli_query($comcon, $query_CompruebaPedidoEntregado) or die(mysqli_connect_error());    $row_CompruebaPedidoEntregado = mysqli_fetch_assoc($CompruebaPedidoEntregado);    if ($row_CompruebaPedidoEntregado['estadoEntregadoPedido'] == 1){       $updatePedido = "UPDATE pedidos SET estadoCobroPedido=1, estadoMesaPedido=0, horaCobroPedido='$hora', importePedido=$precioTotal WHERE idPedido=$idPedido";     }else{       $updatePedido = "UPDATE pedidos SET estadoCobroPedido=1, horaCobroPedido='$hora', importePedido=$precioTotal WHERE idPedido=$idPedido";     }    $Result2 = mysqli_query($comcon, $updatePedido) or die(mysqli_connect_error());        //CREAMOS EL TIQUET Y LO AÑADIMOS A LA CARPETA    $pdf->consulta($idPedido);        if ($Result1 && $Result2){       echo "OK";     }else{       echo "ERROR";    }            }?>